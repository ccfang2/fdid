} else{
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post,  df=df, type="FFSCB.t", conf.level=1-scb.post.alpha, n_int=1)
}
View(scb_pre)
View(scb_post)
betahat_spline_post
diag(covhat_spline_post)
ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post, type="FFSCB.z", conf.level=1-scb.post.alpha, n_int=1)
rbind(scb_pre, scb_post[-1])
rbind(scb_pre, scb_post[-1,])
timeVec_pre
timeVec_spline
timeVec_spline
sort(c(timeVec_spline,t0))
length(betahat_spline_post)
betahat_spline_post
len_spline_post
timeVec_spline>=t0
betahat_spline_pre
timeVec_spline<=t0
nrow(scb_pre)
nrow(scb_post)
length(timeVec_spline)
timeVec
length(timeVec)
length(betahat)
timeVec_spline
betahat_spline_post
hat.tau_post
library(devtools)
document()
install()
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
pdf("plot_ci.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
EventStudyPlot_Classical(fdid_scb_est, pos.legend="bottom", scale.legend=1.4)
dev.off()
pdf("plot_scb.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
dev.off()
pdf("plot_scb_ta.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, ta.ts=-2, ta.s=c(1.3,2.3), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
pdf("plot_scb_frmtr.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, frmtr.m=c(0.25,0.25), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
library(pdftools)
pdf_convert("plot_ci.pdf", format = "png", filenames = "plot_ci.png", dpi = 300)
pdf_convert("plot_scb.pdf", format = "png", filenames = "plot_scb.png", dpi = 300)
pdf_convert("plot_scb_ta.pdf", format = "png", filenames = "plot_scb_ta.png", dpi = 300)
pdf_convert("plot_scb_frmtr.pdf", format = "png", filenames = "plot_scb_frmtr.png", dpi = 300)
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
beta=Gdata$beta
cov=Gdata$cov
t0=0
object=NULL
df=NULL
ci.alpha=0.05
scb.pre.alpha=0.05
scb.post.alpha=0.05
# check conditions
if (!is.null(object) && !base::inherits(object,"fdid")) stop("The input 'object' should be either NULL or an output of function 'fdid'.")
if (!is.null(object)) warning("The input 'object' is provided, so 'beta', 'cov' and 't0' are ignored.")
if (!is.null(beta) && !is.matrix(beta)) stop("The input 'beta' should be either NULL or a numeric matrix.")
if (is.null(beta) && is.null(object)) stop("If any of 'beta', 'cov' and 't0' is NULL, 'object' must be provided.")
if (is.matrix(beta) && !is.numeric(beta)) stop("If 'beta' is not NULL, it should be a numeric matrix.")
if (is.matrix(beta) && any(is.na(beta))) stop("The input 'beta' should contain no missing values.")
if (!is.null(cov) && !is.matrix(cov)) stop("The input 'cov' should be eitherNULL or a matrix.")
if (is.null(cov) && is.null(object)) stop("If any of 'beta', 'cov' and 't0' is NULL, 'object' must be provided.")
if (!is.null(t0) && (!is.numeric(t0) || length(t0) != 1)) stop("The input 't0' should be either NULL or a numeric scalar.")
if (!is.null(df) && (!is.numeric(df) || length(df) != 1 || df <= 0)) stop("The input 'df' should be either NULL or a positive integer scalar.")
# extract data
if(is.null(object)) {
# check further conditions
if (!(t0 %in% beta[,2])) stop("t0 should be in the time vector.")
if (beta[,1][which(beta[,2]==t0)]!=0) stop("beta at t0 should be normalized to 0.")
if (any(cov[which(beta[,2]==t0),]!=0) && any(covhat[,which(timeVec==t0)]!=0)) stop("Rows and columns of cov at t0 should all be normalized to 0.")
#beta[,2]       <- beta[,2]-t0
t_order        <- order(beta[,2])
beta           <- beta[t_order,]
colnames(beta) <- c(colnames(beta)[1], "event_t")
cov            <- cov[t_order, t_order]
colnames(cov)  <- rownames(cov) <- beta[,"event_t"]
betahat        <- beta[,1]
covhat         <- cov
timeVec        <- beta[,2]
t0             <- t0
df             <- df
} else {
beta           <- object$beta$coef
cov            <- object$beta$cov
betahat        <- beta[,1]
covhat         <- cov
timeVec        <- beta[,2]
t0             <- object$t0
df             <- object$df
}
if (is.null(df)) {
ci_upper <- betahat+qnorm(p=1-ci.alpha/2)*sqrt(diag(covhat))
ci_lower <- betahat-qnorm(p=1-ci.alpha/2)*sqrt(diag(covhat))
} else {
ci_upper <- betahat+qt(p=1-ci.alpha/2,df=df)*sqrt(diag(covhat))
ci_lower <- betahat-qt(p=1-ci.alpha/2,df=df)*sqrt(diag(covhat))
}
# compute spline interpolation
len_t      <- length(betahat)
len_spline <- 7*len_t
timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline)
while (t0 %in% timeVec_spline) {len_spline <- len_spline+1; timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline) }
timeVec_spline
timeVec_spline[1:(idx_pos-1)]
idx_pos          <- which(timeVec_spline>=t0)[1]
timeVec_spline[1:(idx_pos-1)]
timeVec_spline[idx_pos:len_spline]
idx_pos          <- which(timeVec_spline>=t0)[1]
scb              <- rbind(scb_pre, scb_post[-1,])
# betahat_spline    <- spline(x=timeVec, y=betahat, n=len_spline, method="natural")$y
# betahat_splinefun <- splinefun(x=timeVec, y=betahat, method="natural")
# covhat_spline     <- cov_spline(cov=covhat, grid=timeVec, n_intrpl=len_spline)
# if (any(is.na(covhat))) {
#   covhat_spline <- apply(covhat, 2, function(col) { obs_idx <- !is.na(col); obs_event_t <- timeVec[obs_idx]; obs_col <- col[obs_idx]; spline_fit <- spline(obs_event_t, obs_col, xout = timeVec_spline, method = "natural")$y; spline_fit[timeVec_spline > max(obs_event_t) | timeVec_spline < min(obs_event_t)] <- NA; return(spline_fit)})
#   covhat_spline <- apply(covhat_spline, 1, function(row) { obs_idx <- !is.na(row); obs_event_t <- timeVec[obs_idx]; obs_row <- row[obs_idx]; spline_fit <- spline(obs_event_t, obs_row, xout = timeVec_spline, method = "natural")$y; spline_fit[timeVec_spline > max(obs_event_t) | timeVec_spline < min(obs_event_t)] <- NA; return(spline_fit)})
# } else{
#   covhat_spline <- apply(covhat, 2, function(col) spline(x=timeVec, y=col, n=len_spline, method="natural")$y)
#   covhat_spline <- apply(covhat_spline, 1, function(row) spline(x=timeVec, y=row, n=len_spline, method="natural")$y)
# }
# compute infimum-based simultaneous confidence band for pre-treatment periods via parametric bootstrapping
timeVec_pre     <- timeVec[which(timeVec<=t0)]
betahat_pre     <- betahat[which(timeVec<=t0)]
covhat_pre      <- covhat[which(timeVec<=t0), which(timeVec<=t0)]
diag_covhat_pre <- diag(covhat_pre)
len_spline_pre  <- sum(timeVec_spline<=t0)
betahat_spline_pre     <- spline(x=timeVec_pre, y=betahat_pre, n=len_spline_pre, method="natural")$y
betahat_splinefun_pre  <- splinefun(x=timeVec_pre, y=betahat_pre, method="natural")
covhat_spline_pre      <- cov_spline(cov=covhat_pre, grid=timeVec_pre, n_intrpl=len_spline_pre)
diag_covhat_spline_pre <- diag(covhat_spline_pre)
B <- 500
T_boot <- numeric(B)
set.seed(450)
# for (b in 1:B) {
#   betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
#   betahat_spline_pre_b <- spline(betahat_pre_b, n=len_spline_pre, method="natural")$y
#   t_b <- (betahat_spline_pre_b - betahat_spline_pre)[-len_spline_pre] / sqrt(diag_covhat_spline_pre)[-len_spline_pre]
#   T_boot[b] <- min(abs(t_b))
# }
for (b in 1:B) {
betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
t_b <- (betahat_pre_b - betahat_pre)[-length(betahat_pre)] / sqrt(diag(covhat_pre))[-length(betahat_pre)]
T_boot[b] <- min(abs(t_b))
}
c_alpha <- quantile(T_boot, probs=1-2*scb.pre.alpha, type=6)
scb_pre <- cbind(betahat_spline_pre, betahat_spline_pre+c_alpha*sqrt(diag_covhat_spline_pre), betahat_spline_pre-c_alpha*sqrt(diag_covhat_spline_pre))
# compute supremum-based simultaneous confidence band for post-treatment periods by Kac-Rice formula
timeVec_post     <- timeVec[which(timeVec>=t0)]
betahat_post     <- betahat[which(timeVec>=t0)]
covhat_post      <- covhat[which(timeVec>=t0), which(timeVec>=t0)]
diag_covhat_post <- diag(covhat_post)
len_spline_post  <- sum(timeVec_spline>=t0)
betahat_spline_post     <- spline(x=timeVec_post, y=betahat_post, n=len_spline_post, method="natural")$y
betahat_splinefun_post  <- splinefun(x=timeVec_post, y=betahat_post, method="natural")
covhat_spline_post      <- cov_spline(cov=covhat_post, grid=timeVec_post, n_intrpl=len_spline_post)
diag_covhat_spline_post <- diag(covhat_spline_post)
hat.tau_post            <- ffscb::cov2tau_fun(covhat_spline_post) # there should be no zero in hat.tau_post
if(is.null(df)){
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post, type="FFSCB.z", conf.level=1-scb.post.alpha, n_int=1)
} else{
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post,  df=df, type="FFSCB.t", conf.level=1-scb.post.alpha, n_int=1)
}
idx_pos          <- which(timeVec_spline>=t0)[1]
scb              <- rbind(scb_pre, scb_post[-1,])
x                <- c(timeVec_spline[1:(idx_pos-2)],t0,timeVec_spline[(idx_pos+1):len_spline])
# scb              <- rbind(scb_pre, 0, scb_post)
# x                <- c(timeVec_spline[1:(idx_pos-1)],t0,timeVec_spline[idx_pos:len_spline])
length(x)
nrow(scb)
library(devtools)
document()
library(devtools)
document()
install()
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
beta=Gdata$beta
cov=Gdata$cov
t0=0
object=NULL
df=NULL
ci.alpha=0.05
scb.pre.alpha=0.05
scb.post.alpha=0.05
# check conditions
if (!is.null(object) && !base::inherits(object,"fdid")) stop("The input 'object' should be either NULL or an output of function 'fdid'.")
if (!is.null(object)) warning("The input 'object' is provided, so 'beta', 'cov' and 't0' are ignored.")
if (!is.null(beta) && !is.matrix(beta)) stop("The input 'beta' should be either NULL or a numeric matrix.")
if (is.null(beta) && is.null(object)) stop("If any of 'beta', 'cov' and 't0' is NULL, 'object' must be provided.")
if (is.matrix(beta) && !is.numeric(beta)) stop("If 'beta' is not NULL, it should be a numeric matrix.")
if (is.matrix(beta) && any(is.na(beta))) stop("The input 'beta' should contain no missing values.")
if (!is.null(cov) && !is.matrix(cov)) stop("The input 'cov' should be eitherNULL or a matrix.")
if (is.null(cov) && is.null(object)) stop("If any of 'beta', 'cov' and 't0' is NULL, 'object' must be provided.")
if (!is.null(t0) && (!is.numeric(t0) || length(t0) != 1)) stop("The input 't0' should be either NULL or a numeric scalar.")
if (!is.null(df) && (!is.numeric(df) || length(df) != 1 || df <= 0)) stop("The input 'df' should be either NULL or a positive integer scalar.")
# extract data
if(is.null(object)) {
# check further conditions
if (!(t0 %in% beta[,2])) stop("t0 should be in the time vector.")
if (beta[,1][which(beta[,2]==t0)]!=0) stop("beta at t0 should be normalized to 0.")
if (any(cov[which(beta[,2]==t0),]!=0) && any(covhat[,which(timeVec==t0)]!=0)) stop("Rows and columns of cov at t0 should all be normalized to 0.")
#beta[,2]       <- beta[,2]-t0
t_order        <- order(beta[,2])
beta           <- beta[t_order,]
colnames(beta) <- c(colnames(beta)[1], "event_t")
cov            <- cov[t_order, t_order]
colnames(cov)  <- rownames(cov) <- beta[,"event_t"]
betahat        <- beta[,1]
covhat         <- cov
timeVec        <- beta[,2]
t0             <- t0
df             <- df
} else {
beta           <- object$beta$coef
cov            <- object$beta$cov
betahat        <- beta[,1]
covhat         <- cov
timeVec        <- beta[,2]
t0             <- object$t0
df             <- object$df
}
# estimate point-wise confidence interval
if (is.null(df)) {
ci_upper <- betahat+qnorm(p=1-ci.alpha/2)*sqrt(diag(covhat))
ci_lower <- betahat-qnorm(p=1-ci.alpha/2)*sqrt(diag(covhat))
} else {
ci_upper <- betahat+qt(p=1-ci.alpha/2,df=df)*sqrt(diag(covhat))
ci_lower <- betahat-qt(p=1-ci.alpha/2,df=df)*sqrt(diag(covhat))
}
# compute spline interpolation
len_t      <- length(betahat)
len_spline <- 12*len_t
timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline)
while (t0 %in% timeVec_spline) {len_spline <- len_spline+1; timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline) }
# compute infimum-based simultaneous confidence band for pre-treatment periods via parametric bootstrapping
timeVec_pre     <- timeVec[which(timeVec<=t0)]
betahat_pre     <- betahat[which(timeVec<=t0)]
covhat_pre      <- covhat[which(timeVec<=t0), which(timeVec<=t0)]
diag_covhat_pre <- diag(covhat_pre)
len_spline_pre  <- sum(timeVec_spline<=t0)
betahat_spline_pre     <- spline(x=timeVec_pre, y=betahat_pre, n=len_spline_pre, method="natural")$y
betahat_splinefun_pre  <- splinefun(x=timeVec_pre, y=betahat_pre, method="natural")
covhat_spline_pre      <- cov_spline(cov=covhat_pre, grid=timeVec_pre, n_intrpl=len_spline_pre)
diag_covhat_spline_pre <- diag(covhat_spline_pre)
B <- 500
T_boot <- numeric(B)
set.seed(450)
# for (b in 1:B) {
#   betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
#   betahat_spline_pre_b <- spline(betahat_pre_b, n=len_spline_pre, method="natural")$y
#   t_b <- (betahat_spline_pre_b - betahat_spline_pre)[-len_spline_pre] / sqrt(diag_covhat_spline_pre)[-len_spline_pre]
#   T_boot[b] <- min(abs(t_b))
# }
for (b in 1:B) {
betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
t_b <- (betahat_pre_b - betahat_pre)[-length(betahat_pre)] / sqrt(diag(covhat_pre))[-length(betahat_pre)]
T_boot[b] <- min(abs(t_b))
}
c_alpha <- quantile(T_boot, probs=1-2*scb.pre.alpha, type=6)
scb_pre <- cbind(betahat_spline_pre, betahat_spline_pre+c_alpha*sqrt(diag_covhat_spline_pre), betahat_spline_pre-c_alpha*sqrt(diag_covhat_spline_pre))
# compute supremum-based simultaneous confidence band for post-treatment periods by Kac-Rice formula
timeVec_post     <- timeVec[which(timeVec>=t0)]
betahat_post     <- betahat[which(timeVec>=t0)]
covhat_post      <- covhat[which(timeVec>=t0), which(timeVec>=t0)]
diag_covhat_post <- diag(covhat_post)
len_spline_post  <- sum(timeVec_spline>=t0)
betahat_spline_post     <- spline(x=timeVec_post, y=betahat_post, n=len_spline_post, method="natural")$y
betahat_splinefun_post  <- splinefun(x=timeVec_post, y=betahat_post, method="natural")
covhat_spline_post      <- cov_spline(cov=covhat_post, grid=timeVec_post, n_intrpl=len_spline_post)
diag_covhat_spline_post <- diag(covhat_spline_post)
hat.tau_post            <- ffscb::cov2tau_fun(covhat_spline_post) # there should be no zero in hat.tau_post
if(is.null(df)){
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post, type="FFSCB.z", conf.level=1-scb.post.alpha, n_int=1)
} else{
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post,  df=df, type="FFSCB.t", conf.level=1-scb.post.alpha, n_int=1)
}
# derive the spline functions
# idx_pos          <- which(timeVec_spline>=t0)[1]
# scb              <- rbind(scb_pre, scb_post[-1,])
# x                <- c(timeVec_spline[1:(idx_pos-2)],t0,timeVec_spline[(idx_pos+1):len_spline])
# # scb              <- rbind(scb_pre, 0, scb_post)
# # x                <- c(timeVec_spline[1:(idx_pos-1)],t0,timeVec_spline[idx_pos:len_spline])
#
# scb_ub_splinefun  <- splinefun(x=x, y=scb[,(ncol(scb)-1)], method="natural")
# scb_lb_splinefun  <- splinefun(x=x, y=scb[,ncol(scb)], method="natural")
timeVec_spline_pre <- timeVec_spline[timeVec_spline<=t0]
timeVec_spline_pre <- sort(c(timeVec_spline_pre[-length(timeVec_spline_pre)],t0))
scb_ub_splinefun_pre  <- splinefun(x=timeVec_spline_pre, y=scb_pre[,(ncol(scb_pre)-1)], method="natural")
scb_lb_splinefun_pre  <- splinefun(x=timeVec_spline_pre, y=scb_pre[,ncol(scb_pre)], method="natural")
timeVec_spline_post <- timeVec_spline[timeVec_spline>=t0]
timeVec_spline_post <- sort(c(timeVec_spline_post[-1],t0))
scb_ub_splinefun_post  <- splinefun(x=timeVec_spline_post, y=scb_post[,(ncol(scb_post)-1)], method="natural")
scb_lb_splinefun_post  <- splinefun(x=timeVec_spline_post, y=scb_post[,ncol(scb_post)], method="natural")
scb_ub_splinefun <- function(t) ifelse(t<=t0, scb_ub_splinefun_pre(t), scb_ub_splinefun_post(t))
scb_lb_splinefun <- function(t) ifelse(t<=t0, scb_lb_splinefun_pre(t), scb_lb_splinefun_post(t))
betahat_splinefun <- function(t) (scb_ub_splinefun(t)+scb_lb_splinefun(t))/2
curve( betahat_splinefun,-10,12,n=200,ylim=c(-0.05,0.15))
curve( scb_ub_splinefun ,-10,12,n=200,add=TRUE)
curve( scb_lb_splinefun ,-10,12,n=200,add=TRUE)
abline(h=0,lty=2)
abline(v=0,lty=2)
curve( betahat_splinefun,-10,12,n=500,ylim=c(-0.05,0.15))
curve( scb_ub_splinefun ,-10,12,n=500,add=TRUE)
curve( scb_lb_splinefun ,-10,12,n=500,add=TRUE)
abline(h=0,lty=2)
abline(v=0,lty=2)
# compute spline interpolation
len_t      <- length(betahat)
len_spline <- 10*len_t
timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline)
while (t0 %in% timeVec_spline) {len_spline <- len_spline+1; timeVec_spline <- seq(min(timeVec), max(timeVec), length.out=len_spline) }
# betahat_spline    <- spline(x=timeVec, y=betahat, n=len_spline, method="natural")$y
# betahat_splinefun <- splinefun(x=timeVec, y=betahat, method="natural")
# covhat_spline     <- cov_spline(cov=covhat, grid=timeVec, n_intrpl=len_spline)
# if (any(is.na(covhat))) {
#   covhat_spline <- apply(covhat, 2, function(col) { obs_idx <- !is.na(col); obs_event_t <- timeVec[obs_idx]; obs_col <- col[obs_idx]; spline_fit <- spline(obs_event_t, obs_col, xout = timeVec_spline, method = "natural")$y; spline_fit[timeVec_spline > max(obs_event_t) | timeVec_spline < min(obs_event_t)] <- NA; return(spline_fit)})
#   covhat_spline <- apply(covhat_spline, 1, function(row) { obs_idx <- !is.na(row); obs_event_t <- timeVec[obs_idx]; obs_row <- row[obs_idx]; spline_fit <- spline(obs_event_t, obs_row, xout = timeVec_spline, method = "natural")$y; spline_fit[timeVec_spline > max(obs_event_t) | timeVec_spline < min(obs_event_t)] <- NA; return(spline_fit)})
# } else{
#   covhat_spline <- apply(covhat, 2, function(col) spline(x=timeVec, y=col, n=len_spline, method="natural")$y)
#   covhat_spline <- apply(covhat_spline, 1, function(row) spline(x=timeVec, y=row, n=len_spline, method="natural")$y)
# }
# compute infimum-based simultaneous confidence band for pre-treatment periods via parametric bootstrapping
timeVec_pre     <- timeVec[which(timeVec<=t0)]
betahat_pre     <- betahat[which(timeVec<=t0)]
covhat_pre      <- covhat[which(timeVec<=t0), which(timeVec<=t0)]
diag_covhat_pre <- diag(covhat_pre)
len_spline_pre  <- sum(timeVec_spline<=t0)
betahat_spline_pre     <- spline(x=timeVec_pre, y=betahat_pre, n=len_spline_pre, method="natural")$y
betahat_splinefun_pre  <- splinefun(x=timeVec_pre, y=betahat_pre, method="natural")
covhat_spline_pre      <- cov_spline(cov=covhat_pre, grid=timeVec_pre, n_intrpl=len_spline_pre)
diag_covhat_spline_pre <- diag(covhat_spline_pre)
B <- 500
T_boot <- numeric(B)
set.seed(450)
# for (b in 1:B) {
#   betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
#   betahat_spline_pre_b <- spline(betahat_pre_b, n=len_spline_pre, method="natural")$y
#   t_b <- (betahat_spline_pre_b - betahat_spline_pre)[-len_spline_pre] / sqrt(diag_covhat_spline_pre)[-len_spline_pre]
#   T_boot[b] <- min(abs(t_b))
# }
for (b in 1:B) {
betahat_pre_b <- MASS::mvrnorm(1, mu=betahat_pre, Sigma=covhat_pre)
t_b <- (betahat_pre_b - betahat_pre)[-length(betahat_pre)] / sqrt(diag(covhat_pre))[-length(betahat_pre)]
T_boot[b] <- min(abs(t_b))
}
c_alpha <- quantile(T_boot, probs=1-2*scb.pre.alpha, type=6)
scb_pre <- cbind(betahat_spline_pre, betahat_spline_pre+c_alpha*sqrt(diag_covhat_spline_pre), betahat_spline_pre-c_alpha*sqrt(diag_covhat_spline_pre))
# compute supremum-based simultaneous confidence band for post-treatment periods by Kac-Rice formula
timeVec_post     <- timeVec[which(timeVec>=t0)]
betahat_post     <- betahat[which(timeVec>=t0)]
covhat_post      <- covhat[which(timeVec>=t0), which(timeVec>=t0)]
diag_covhat_post <- diag(covhat_post)
len_spline_post  <- sum(timeVec_spline>=t0)
betahat_spline_post     <- spline(x=timeVec_post, y=betahat_post, n=len_spline_post, method="natural")$y
betahat_splinefun_post  <- splinefun(x=timeVec_post, y=betahat_post, method="natural")
covhat_spline_post      <- cov_spline(cov=covhat_post, grid=timeVec_post, n_intrpl=len_spline_post)
diag_covhat_spline_post <- diag(covhat_spline_post)
hat.tau_post            <- ffscb::cov2tau_fun(covhat_spline_post) # there should be no zero in hat.tau_post
if(is.null(df)){
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post, type="FFSCB.z", conf.level=1-scb.post.alpha, n_int=1)
} else{
scb_post <- ffscb::confidence_band(x=betahat_spline_post, cov.x=covhat_spline_post, tau=hat.tau_post,  df=df, type="FFSCB.t", conf.level=1-scb.post.alpha, n_int=1)
}
# derive the spline functions
timeVec_spline_pre <- timeVec_spline[timeVec_spline<=t0]
timeVec_spline_pre <- sort(c(timeVec_spline_pre[-length(timeVec_spline_pre)],t0))
scb_ub_splinefun_pre  <- splinefun(x=timeVec_spline_pre, y=scb_pre[,(ncol(scb_pre)-1)], method="natural")
scb_lb_splinefun_pre  <- splinefun(x=timeVec_spline_pre, y=scb_pre[,ncol(scb_pre)], method="natural")
timeVec_spline_post <- timeVec_spline[timeVec_spline>=t0]
timeVec_spline_post <- sort(c(timeVec_spline_post[-1],t0))
scb_ub_splinefun_post  <- splinefun(x=timeVec_spline_post, y=scb_post[,(ncol(scb_post)-1)], method="natural")
scb_lb_splinefun_post  <- splinefun(x=timeVec_spline_post, y=scb_post[,ncol(scb_post)], method="natural")
scb_ub_splinefun <- function(t) ifelse(t<=t0, scb_ub_splinefun_pre(t), scb_ub_splinefun_post(t))
scb_lb_splinefun <- function(t) ifelse(t<=t0, scb_lb_splinefun_pre(t), scb_lb_splinefun_post(t))
betahat_splinefun <- function(t) (scb_ub_splinefun(t)+scb_lb_splinefun(t))/2
curve( betahat_splinefun,-10,12,n=500,ylim=c(-0.05,0.15))
curve( scb_ub_splinefun ,-10,12,n=500,add=TRUE)
curve( scb_lb_splinefun ,-10,12,n=500,add=TRUE)
abline(h=0,lty=2)
abline(v=0,lty=2)
library(devtools)
document()
install()
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
pdf("plot_ci.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
EventStudyPlot_Classical(fdid_scb_est, pos.legend="bottom", scale.legend=1.4)
dev.off()
pdf("plot_scb.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
dev.off()
pdf("plot_scb_ta.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, ta.ts=-2, ta.s=c(1.3,2.3), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
pdf("plot_scb_frmtr.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, frmtr.m=c(0.25,0.25), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
library(pdftools)
pdf_convert("plot_ci.pdf", format = "png", filenames = "plot_ci.png", dpi = 300)
pdf_convert("plot_scb.pdf", format = "png", filenames = "plot_scb.png", dpi = 300)
pdf_convert("plot_scb_ta.pdf", format = "png", filenames = "plot_scb_ta.png", dpi = 300)
pdf_convert("plot_scb_frmtr.pdf", format = "png", filenames = "plot_scb_frmtr.png", dpi = 300)
libra
library(devtools)
document()
install()
library(kpgdown)
library(pkgdown)
build_site()
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
pdf("plot_ci.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
EventStudyPlot_Classical(fdid_scb_est, pos.legend="bottom", scale.legend=1.4)
dev.off()
pdf("plot_scb.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
dev.off()
pdf("plot_scb_ta.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, ta.ts=-2, ta.s=c(1.4,2.3), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
pdf("plot_scb_frmtr.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, frmtr.m=c(0.25,0.25), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
library(pdftools)
pdf_convert("plot_ci.pdf", format = "png", filenames = "plot_ci.png", dpi = 300)
pdf_convert("plot_scb.pdf", format = "png", filenames = "plot_scb.png", dpi = 300)
pdf_convert("plot_scb_ta.pdf", format = "png", filenames = "plot_scb_ta.png", dpi = 300)
pdf_convert("plot_scb_frmtr.pdf", format = "png", filenames = "plot_scb_frmtr.png", dpi = 300)
library(pkgdown)
build_site()
library(pkgdown)
build_site()
library(pkgdown)
build_site()
remove.packages("fdid")
devtools::install_github("ccfang2/fdid")
library(devtools)
document()
install()
library(devtools)
document()
install()
library(fdid)
data(Gdata)
Gdata$beta[,"event_t"] <- Gdata$beta[,"event_t"]- Gdata$t0 #Recenter the event time on 0
fdid_scb_est <- fdid_scb(beta=Gdata$beta, cov=Gdata$cov, t0=0)
pdf("plot_ci.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
EventStudyPlot_Classical(fdid_scb_est, pos.legend="bottom", scale.legend=1.4)
dev.off()
pdf("plot_scb.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, pos.legend="bottom", scale.legend=1.4, note.pre=FALSE, ci.post=TRUE)
dev.off()
pdf("plot_scb_ta.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, ta.ts=-2, ta.s=c(1.4,2.3), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
pdf("plot_scb_frmtr.pdf", width = 8, height = 6)
par(cex.axis = 1.4, cex.lab = 1.4, cex.main = 1.4, family="Times")
plot(fdid_scb_est, frmtr.m=c(0.25,0.25), pos.legend="bottom", scale.legend=1.4, ci.post=TRUE, ref.band.pre = TRUE)
dev.off()
library(pdftools)
pdf_convert("plot_ci.pdf", format = "png", filenames = "plot_ci.png", dpi = 300)
pdf_convert("plot_scb.pdf", format = "png", filenames = "plot_scb.png", dpi = 300)
pdf_convert("plot_scb_ta.pdf", format = "png", filenames = "plot_scb_ta.png", dpi = 300)
pdf_convert("plot_scb_frmtr.pdf", format = "png", filenames = "plot_scb_frmtr.png", dpi = 300)
library(pkgdown)
build_site()
library(devtools)
document()
install()
library(pkgdown)
build_site()
